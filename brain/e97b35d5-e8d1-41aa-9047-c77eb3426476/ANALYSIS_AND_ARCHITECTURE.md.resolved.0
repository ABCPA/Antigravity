# Analyse et Architecture - Antigravity Orchestrator

## 1. Cartographie Actuelle

### Workspaces Identifi√©s

| Workspace | Chemin | Objectif | Type | Niveau de maturit√© |
| :--- | :--- | :--- | :--- | :--- |
| **System Root** | `~/.gemini/antigravity` | M√©ta-gestion, m√©moires globales, workflows transverses | **Infrastructure** | Bas (Exploratoire) |
| **SGQ 1.65** | `C:\VBA\SGQ 1.65` | D√©veloppement VBA Excel expert, normes CPA strictes | **Production** | **√âlev√©** (R√®gles strictes, CI/CD, Agents d√©finis) |

### Agents Existants (Workspace SGQ 1.65)

Bas√© sur `.github/copilot/agents.json` et `AGENTS.md`.

| Nom Agent | Mod√®le | R√¥le R√©el | Forces | Faiblesses |
| :--- | :--- | :--- | :--- | :--- |
| **vba-expert** | `claude-opus-4` | Refactoring lourd, analyse structurelle, patterns d'erreurs (Step 11.4) | Excellente gestion de contexte complexe | Lent, co√ªteux pour t√¢ches simples |
| **copilot-coding-agent** | `gpt-4-turbo` | R√©solution issue, PRs, coding quotidien | Rapide, int√©gr√© au flux GitHub | Moins rigoureux sur l'architecture globale |
| **documentation-agent** | `gpt-4-turbo` | Maintien `ARCHITECTURE.md`, `CHANGELOG`, Docs | Garant de la coh√©rence documentaire | Passif (ne r√©agit pas aux changements sans ordre) |
| **VBA Compatibility Craftsman** | *N/A (Persona)* | Persona unifi√© pour l'interaction utilisateur (VS Code) | Ton professionnel et constant | Ce n'est pas un agent autonome |

### Diagnostic Global

**Forces :**
- **Gouvernance SGQ exemplaire** : Les r√®gles (CP1252, Backups, Headers) sont codifi√©es et respect√©es.
- **Sp√©cialisation claire** : S√©paration nette entre "Coding" et "Refactoring".
- **Outillage** : Scripts PowerShell de validation (`test-vbide-and-compile.ps1`) et Workflows (`vba-compile`, `fix-mojibake`) matures.

**Lacunes :**
- **Absence d'Orchestre** : Pas de point d'entr√©e unique. L'utilisateur doit savoir quel agent/workflow appeler.
- **Silos** : Le Root ne "conna√Æt" pas formellement les capacit√©s de SGQ.
- **Risque Cognitif** : L'utilisateur porte la charge du contexte ("Suis-je en mode global ou projet ?").

---

## 2. Architecture Cible Propos√©e

### Sch√©ma Logique (Textuel)

```mermaid
flowchart TD
    User[Utilisateur] --> Orchestrator[Agent Chef d'Orchestre (Root)]
    
    subgraph "Couche Orchestration & Gouvernance"
        Orchestrator -->|Analyse Intention| Classifier{Classifier}
        Classifier -->|T√¢che Complexe/Plan| Planner[Mode Planning]
        Classifier -->|Question/Quick Fix| Runner[Mode Ex√©cution]
        Orchestrator -.->|Validation| Governance[Garde-Fous Globaux]
    end
    
    subgraph "Couche Agents Sp√©cialis√©s (Routage Dynamique)"
        Runner -->|Domaine VBA/SGQ| AgentSGQ[Proxy vers SGQ Agent]
        Runner -->|Domaine Syst√®me| AgentSys[System/Ops Agent]
        AgentSGQ -->|Refactoring| VBAExpert(vba-expert)
        AgentSGQ -->|Coding| CodAgent(copilot-coding-agent)
        AgentSGQ -->|Docs| DocAgent(documentation-agent)
    end
    
    subgraph "Couche Exp√©rimentation"
        Runner -->|Sandbox| Playground[Playground Zone]
    end
```

### R√¥les des Couches

1.  **Couche Orchestration (The Front Desk)** :  
    *   **R√¥le** : Point de contact unique. Ne fait RIEN lui-m√™me sauf router et valider.
    *   **Responsabilit√©** : Comprendre ("Fixer l'encodage"), Mapper vers une capacit√© ("Use workflow fix-mojibake"), Contextualiser ("Dans SGQ 1.65").
2.  **Couche Agents Sp√©cialis√©s (The Workers)** :  
    *   **R√¥le** : Ex√©cuter la t√¢che avec expertise.
    *   **Responsabilit√©** : Respecter les r√®gles locales (SGQ > Root).
3.  **Couche Gouvernance (The Sheriff)** :  
    *   **R√¥le** : V√©rifier AVANT et APR√àS.
    *   **R√®gles** : "Pas d'hallucination de fichiers", "Respect du CP1252", "Validation utilisateur pour actions destructives".

---

## 3. Sp√©cification de l'Agent Chef d'Orchestre

**Mission :**  
√ätre l'interface intelligente entre l'intention floue de l'utilisateur et la rigeur m√©canique des agents sp√©cialis√©s.

**Responsabilit√©s :**
1.  **Qualifier la demande** : Est-ce une t√¢che de Planification, d'Ex√©cution ou de V√©rification ?
2.  **Identifier le Contexte** : Quel workspace est concern√© ?
3.  **Router** : Vers l'agent ou le workflow le plus apte.
4.  **Synth√©tiser** : Rapporter le r√©sultat final √† l'utilisateur.

**Ce qu'il ne doit JAMAIS faire :**
- Modifier directement un fichier code (hors fichiers m√©ta/t√¢ches).
- Inventer une commande ou un chemin de fichier.
- Ignorer une erreur d'un sous-agent.

**Matrice de D√©cision :**
| Type de D√©cision | Exemple | Autorit√© |
| :--- | :--- | :--- |
| **Automatique** | Lecture de fichiers, listage de dossiers, appel de workflows de lecture | 100% Agent |
| **Assist√©e** | Proposition de plan, choix d'architecture | Agent propose, Humain valide |
| **Validation Humaine** | Suppression de fichiers, √©criture sur `main`, d√©ploiement | **BLOQUANT** sans `notify_user` |

---

## 4. Prompt Syst√®me de l'Agent Chef d'Orchestre (V1)

```markdown
# Role: Antigravity Orchestrator
Tu es le Chef d'Orchestre du syst√®me Antigravity. Ton but est d'analyser l'intention de l'utilisateur et de coordonner les ressources sp√©cialis√©es (Agents, Workflows) pour accomplir la mission.

## Directives Fondamentales
1.  **Context-First** : Ne jamais agir sans avoir situ√© le contexte (Workspace actif). Utilise `list_dir` et `task_boundary` imm√©diatement.
2.  **No Hallucination** : Si tu ne vois pas un fichier, il n'existe pas. Si tu ne connais pas une commande, ne l'invente pas.
3.  **Delegation-Over-Action** : Ta valeur ajout√©e est le routage. Si une t√¢che concerne le VBA, d√©l√®gue aux r√®gles du "VBA Compatibility Craftsman".

## Logique de Routage
1.  **Analyse** :
    - Si la demande est vague ("√áa bug"), passe en MODE PLANNING.
    - Si la demande est pr√©cise ("Lance le script X"), passe en MODE EXECUTION.
2.  **Identification Domaine** :
    - **Projet SGQ** (`C:\VBA\SGQ 1.65`) -> Applique STRICTEMENT `AGENTS.md` et `.github/copilot/agents.json`.
    - **Syst√®me** (`.gemini/antigravity`) -> Gestion de configuration, m√©moires.
3.  **Ex√©cution** :
    - Utilise `task_boundary` pour structurer l'avancement.
    - Utilise `notify_user` si tu es bloqu√© ou dois valider une destruction.

## Format de Sortie
Toujours commencer tes r√©ponses par un micro-r√©sum√© de l'√©tat :
"üéØ **Objectif** : [Rappel court] | üìÇ **Contexte** : [Workspace Actif] | ü§ñ **Agent Actif** : [Nom]"

## Gestion d'Erreur
Si un outil √©choue :
1.  Ne pas r√©essayer stupidement la m√™me chose.
2.  Lire le message d'erreur.
3.  Proposer une correction ou demander de l'aide √† l'utilisateur.

## Conventions Sp√©cifiques (SGQ 1.65)
- Encodage : CP1252 OBLIGATOIRE.
- Langue : Code EN, Commentaires FR.
- S√©curit√© : Backups avant toute √©dition (`.bak`).
```

---

## 5. Plan d'Ex√©cution Recommand√©

### Phase 1 : Consolidation (Imm√©diat)
1.  **Officialiser** ce document dans `C:\Users\AbelBoudreau\.gemini\antigravity\brain\ARCHITECTURE_TYPE.md`.
2.  **Cr√©er** l'Agent Chef d'Orchestre via un fichier `.agent/orchestrator.json` (ou format compatible) √† la racine.
3.  **Tester** le routage manuel : "Analyse le projet SGQ" -> Doit lister les fichiers et proposer de charger le contexte SGQ.

### Phase 2 : Int√©gration (Moyen Terme)
1.  **Connecter** les workflows globaux (`fix-mojibake`) pour qu'ils soient appelables par l'Orchestrator.
2.  **D√©pr√©cier** l'usage direct des agents sp√©cialis√©s hors contexte.

### Phase 3 : Automatisation (Long Terme)
1.  Mise en place d'un "Classifier" automatique bas√© sur l'historique des conversations (`brain/conversations`).

---

## Actions Imm√©diates Suggest√©es
- [ ] Valider cette architecture cible.
- [ ] Sauvegarder ce plan dans `~/.gemini/antigravity/docs/ORCHESTRATION_PLAN.md`.
- [ ] Cr√©er le prompt syst√®me du Chef d'Orchestre.

## D√©cisions √† Valider par l'Humain
1.  **Centralisation** : Acceptez-vous que le dossier `.gemini/antigravity` devienne le point d'entr√©e unique ?
2.  **Autorit√©** : Confirmez-vous que les r√®gles locales (SGQ) pr√©valent sur les r√®gles globales en cas de conflit ?
3.  **Maturit√©** : Le niveau actuel est estim√© √† **Moyen** (Briques solides, ciment manquant).
